import{j as t,S as u}from"./index-3_qVLhXE.js";import{i as l,P as D,s as oe,K as re,w as h,J as le,F as ie,z as ce,O as c}from"./vendor-antd-BiNc4BQP.js";import{r as n}from"./vendor-react-DcqtUZ_G.js";import{c as v}from"./commonService-BP-nhihU.js";import{c as de}from"./cpMonitorService-_iOoM6TO.js";import{s as M}from"./scheduleService-Dd4Zu0yX.js";import{e as me}from"./options-DHqL16EA.js";import ue from"./addChargingSchedule-CrALNLDZ.js";import he from"./detail-COaZS9oi.js";import pe from"./editChargingSchedule-90HaHfjv.js";import"./vendor-ui-BASYQBt4.js";import"./vendor-utils-DcB4TerO.js";function ke(){const[b,p]=n.useState(1),[k,f]=n.useState(!1),[N,x]=n.useState(!1),[d,Y]=n.useState([]),[I,g]=n.useState(!1),[_,C]=n.useState(null),[o,r]=n.useState({}),[T,i]=n.useState(0),[P,E]=n.useState([]),[m,A]=n.useState([]),[H,R]=n.useState([]),[$,w]=n.useState(!1),[K,z]=n.useState(0),O=e=>e.split(" ").map(s=>s.charAt(0).toUpperCase()).join(""),U=[{title:"Charge Point",dataIndex:"id_tag",key:"id_tag",render:(e,s)=>t.jsx(l,{type:"link",onClick:()=>Z(s),children:e})},{title:`Scheduled Time(${(()=>{const e={timeZoneName:"long"},y=new Intl.DateTimeFormat("en-US",e).formatToParts(new Date).find(S=>S.type==="timeZoneName").value;return O(y)})()})`,dataIndex:"scheduled_time",key:"scheduled_time"},{title:"Energy Mode",dataIndex:"mode",key:"mode",render:e=>t.jsx("span",{className:e==="Discharge"?"discharge_mode":"charge_mode",children:e})},{title:"Duration",dataIndex:"duration",key:"duration"},{title:"Repeat Kind",dataIndex:"repeat_kind",key:"repeat_kind"},{title:"Operation",width:"140px",key:"operation",render:(e,s)=>t.jsx("div",{className:"operations",children:t.jsx(D,{title:"Confirm delete?",placement:"bottom",okText:"Confirm",cancelText:"Cancel",onConfirm:()=>{j(s.id)},children:t.jsx(l,{type:"link",danger:!0,icon:t.jsx(u,{icon:"Delete",size:"20"}),children:"Delete"})})})}],V=()=>{f(!0)},F=e=>{C(e),x(!0)},Z=e=>{C(e),g(!0)},L=e=>{Y(e)},q=()=>{const e={...o};p(1),delete e.page,r(e),i(Date.now())},B=e=>{p(e),r({...o,page:e}),i(Date.now())},J=()=>{r({}),p(1),i(Date.now())},Q=async()=>{const{detail:e}=await v.getUsers({num:100});E(e.results.map(a=>({name:`${a.first_name} ${a.last_name}`,phone:a.phone,email:a.email,user_id:a.user_id})));const s=await de.queryAll({num:100});A(s.detail.results.map(a=>({id:a.id,id_tag:a.id_tag,v2g_support:a.v2g_support,connector_no:a.brand_model.connector_no})))},G=e=>e.map(s=>{const a=(new Date(s.profile_end_datetime).getTime()-new Date(s.profile_start_datetime).getTime())/1e3,y=Math.floor(a/3600),S=Math.floor(a%3600/60),ee=Math.floor(a%60),{id:te,last_name:se,first_name:ae}=s,ne=c().startOf("day").add(y,"hour").add(S,"minute").add(ee,"second").format("HH:mm:ss");return{...s,key:te,user:`${se} ${ae}`,repeat_kind:s.ocpp_recurrency_kind||"None",mode:s.mode==="1"?"Charge":"Discharge",duration:ne,start_time:c(s.profile_start_datetime).format("YYYY-MM-DD HH:mm:ss"),end_time:c(s.profile_end_datetime).format("YYYY-MM-DD HH:mm:ss"),scheduled_time:`${c(s.profile_start_datetime).format("YYYY-MM-DD HH:mm:ss")} - ${c(s.profile_end_datetime).format("YYYY-MM-DD HH:mm:ss")}`}}),W=async()=>{w(!0);const e=await M.queryAll(o),{results:s,count:a}=e.detail;R(G(s||[])),z(a),w(!1)},X=()=>d.map(e=>e.split(v.rowKeySplit)[0]),j=async e=>{try{const s=await M.del({charge_profile_ids:e?[e]:X()});s?.code===200&&(oe.success(s.message),i(Date.now()))}catch{}};return n.useEffect(()=>{W()},[T]),n.useEffect(()=>{Q(),i(Date.now())},[]),t.jsxs("div",{className:"main-content",children:[t.jsxs("div",{className:"search-area flex items-center justify-start",children:[t.jsxs("div",{className:"search-item",children:[t.jsx("div",{className:"label mb-2",children:"Charge Point"}),t.jsx(re,{className:"w-full",placeholder:"Enter",onChange:e=>{r({...o,id_tag:e.target.value})}})]}),t.jsxs("div",{className:"search-item",children:[t.jsx("div",{className:"label",children:"User"}),t.jsx(h,{className:"w-full",allowClear:!0,value:o.user_id,style:{width:"150px"},onChange:e=>{r({...o,user_id:e})},placeholder:"Select",children:P.map(e=>t.jsx(h.Option,{value:e.user_id,children:e.name},e.user_id))})]}),t.jsxs("div",{className:"search-item",children:[t.jsx("div",{className:"label",children:"Energy Mode"}),t.jsx(h,{placeholder:"Select",allowClear:!0,style:{width:"210px"},onChange:e=>{r({...o,mode:e})},children:me.map(e=>t.jsx(h.Option,{value:e.value,children:e.label},e.value))})]}),t.jsx("div",{className:"search-btn",children:t.jsx(l,{icon:t.jsx(u,{icon:"Search",size:"20"}),type:"primary",loading:$,onClick:q})}),t.jsx("div",{className:"search-btn clear",children:t.jsx(l,{icon:t.jsx(u,{icon:"Close",size:"24",color:"#999"}),type:"primary",onClick:J})})]}),t.jsx("div",{className:"flex items-center justify-between",children:t.jsxs("div",{className:"operation-area flex items-center justify-start",children:[t.jsx(l,{type:"primary",icon:t.jsx(le,{}),onClick:V,children:"Add Schedule"}),t.jsx(D,{placement:"bottom",okText:"Confirm",cancelText:"Cancel",title:"Confirm delete?",onConfirm:()=>{j()},children:t.jsx(l,{disabled:d.length===0,className:"ml-3",icon:t.jsx(u,{color:d.length===0?"#999":"currentColor",icon:"Delete",size:"20"}),children:"Bulk Delete"})})]})}),t.jsx(ie,{columns:U,dataSource:H,pagination:!1,rowKey:"key",rowSelection:{selectedRowKeys:d,onChange:L}}),t.jsx("div",{className:"mr-4 mt-4 flex justify-end",children:t.jsx(ce,{total:K,current:b,showSizeChanger:!1,showQuickJumper:!0,onChange:B})}),m.length>0&&t.jsx(ue,{visible:k,onCancel:()=>f(!1),onConfirm:()=>f(!1),chargePoints:m}),m.length>0&&_&&t.jsx(pe,{visible:N,chargePoints:m,onCancel:()=>x(!1),onConfirm:()=>x(!1),record:_}),t.jsx(he,{visible:I,onCancel:()=>g(!1),record:_,onDelete:e=>{j(e),g(!1)},onEdit:F})]})}export{ke as default};
