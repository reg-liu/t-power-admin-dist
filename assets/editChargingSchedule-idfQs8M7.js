import{j as e,S as D}from"./index-BnnhTYue.js";import{O as P,H as i,E as J,i as f,w as l,$ as E,o as U,x as w,j as X,Q as M,s as S}from"./vendor-antd-BiNc4BQP.js";import{r as d}from"./vendor-react-DcqtUZ_G.js";import{s as Z}from"./scheduleService-BhpdH6kG.js";import{d as O,b as ee,r as te}from"./options-DHqL16EA.js";import"./vendor-ui-BASYQBt4.js";import"./vendor-utils-DcB4TerO.js";function de({visible:g,onCancel:C,record:r,chargePoints:N,onConfirm:T}){const p=N?.find(t=>t.id===r?.charge_point_id),Y=p?.connector_no===2?O:[O[0]],q=P(r.profile_start_datetime),R=P(r.profile_end_datetime),o=r?.mode==="1"?"charge_mode":"discharge_mode",A=r.soc[r.mode==="1"?"max":"min"]*100,b=r?.ocpp_charging_schedule_period?.map(t=>({limit:t.limit,startAfter:t.startPeriod/60,time:Date.now()})),[x]=i.useForm(),[B,y]=d.useState(!1),[_,F]=d.useState(b.length>0),[m,u]=d.useState([{limit:"",startAfter:"",time:Date.now()}]),[j,H]=d.useState(r.ocpp_charging_rate_unit==="A"?"current":"power"),[k,V]=d.useState(p?.v2g_support||!1),[v,ae]=d.useState(A);d.useEffect(()=>{g&&(x.setFieldsValue({charge_point_id:p?.id_tag,connector_id:r?.connector_id,repeat_kind:r.ocpp_recurrency_kind||"None",start_time:q,end_time:R,mode:o,soc:A}),u(b))},[g,r]);const L=()=>{V(!0),u([...m,{limit:"",startAfter:"",time:Date.now()}])},z=t=>{F(t)},W=t=>{H(t),u([{limit:"",startAfter:"",time:Date.now()}])},$=t=>{const s=m.filter((a,n)=>n!==t);u([...s])},G=(t,s)=>{const a=[...m],n=a.map((c,h)=>h===t?{...a[t]||{limit:"",startAfter:"",time:Date.now()},limit:s}:c);u(n)},K=(t,s)=>{const a=[...m],n=a.map((c,h)=>h===t?{...a[t]||{limit:"",startAfter:"",time:Date.now()},startAfter:s}:c);u(n)},Q=async()=>{let t=!0;const s=_?m.map(a=>((a.limit===""||a.startAfter==="")&&(t=!1),{limit:a.limit,startPeriod:a.startAfter*60})):[];if(_&&(!t||s.length===0)){S.error("Please Input Limit and Start After");return}if(k&&!v){S.error("Please Enter SoC");return}x.validateFields().then(async a=>{let n={max:.92};p.v2g_support==="V2G"&&(n=o==="charge_mode"?{max:(v||0)/100}:{min:(v||0)/100});let c={charge_point_id:p.id,connector_id:a.connector_id,mode:o==="charge_mode"?"default":"v2g",soc:n,ocpp_charging_schedule_period:s};c={...c,smart_charge:!0,profile_start_datetime:new Date(a.start_time).toISOString(),profile_end_datetime:new Date(a.end_time).toISOString(),ocpp_charging_profile_id:r?.ocpp_charging_profile_id,ocpp_stack_level:2,ocpp_charging_profile_purpose:"TxProfile",ocpp_charging_profile_kind:"Relative",ocpp_charging_rate_unit:j==="current"?"A":"B",ocpp_recurrency_kind:a.repeat_kind};const h=c;y(!0);const I=await Z.update(r.id,{...h});y(!1),I?.code===200&&(S.success(I.message),T())})};return e.jsx(J,{title:"Edit Schedule",open:g,onCancel:C,zIndex:1002,footer:[e.jsxs("div",{className:"footer-normal-btns",children:[e.jsx(f,{onClick:C,children:"Cancel"},"cancel"),e.jsx(f,{type:"primary",loading:B,onClick:Q,children:"Edit"},"confirm")]},"add-schedule-footer")],children:e.jsx("div",{className:`modal-form ${o}_form`,children:e.jsxs(i,{form:x,layout:"vertical",children:[e.jsx(i.Item,{name:"charge_point_id",label:"Charge Point",rules:[{required:!0}],children:e.jsx(l,{className:"w-full",allowClear:!0,disabled:!0,placeholder:"Select",children:N.map(t=>e.jsx(l.Option,{value:t.id_tag,children:t.id_tag},t.id_tag))})}),e.jsxs("div",{className:"two-column",children:[e.jsx(i.Item,{name:"connector_id",label:"Connector",rules:[{required:!0}],children:e.jsx(l,{className:"w-full",allowClear:!0,placeholder:"Select",children:Y.map(t=>e.jsx(l.Option,{value:t.value,children:t.label},t.value))})}),e.jsx(i.Item,{label:""})]}),e.jsxs("div",{className:"two-column",children:[e.jsx(i.Item,{name:"mode",label:"Energy Mode",rules:[{required:!0}],children:k?e.jsx(l,{placeholder:"Select",value:o,style:{width:"100%"},children:ee.map(t=>e.jsx(l.Option,{value:t.value,children:e.jsx("span",{className:t.value,children:t.label})},t.value))}):e.jsx("div",{className:"form-status charge_mode",children:"Charge Mode"})}),e.jsx(i.Item,{label:""})]}),e.jsxs("div",{className:"two-column",children:[e.jsx(i.Item,{name:"start_time",label:"Start Time",rules:[{required:!0}],children:e.jsx(E,{showTime:!0,format:"YYYY-MM-DD HH:mm"})}),e.jsx(i.Item,{name:"end_time",label:"End Time",rules:[{required:!0}],children:e.jsx(E,{showTime:!0,format:"YYYY-MM-DD HH:mm"})})]}),e.jsxs("div",{className:"two-column",children:[e.jsx(i.Item,{name:"repeat_kind",label:"Repeat Kind",children:e.jsx(l,{allowClear:!0,children:te.map(t=>e.jsx(l.Option,{value:t.value,children:t.label},t.value))})}),e.jsx(i.Item,{label:""})]}),e.jsxs("div",{className:"between-wrapper mt-2",children:[e.jsx("span",{}),e.jsxs("div",{className:"switch",children:["With Profile",e.jsx(U,{checked:_,onChange:z})]})]}),_&&e.jsxs("div",{className:"mt-4",children:[e.jsxs("div",{className:"between-wrapper",children:[e.jsxs(w.Group,{optionType:"button",value:j,onChange:t=>W(t.target.value),className:"my-4",children:[e.jsx(w.Button,{value:"current",children:"Current"}),e.jsx(w.Button,{value:"power",children:"Power"})]}),e.jsx(f,{type:"link",icon:e.jsx(D,{icon:o==="discharge_mode"?"Add2":"Add",color:o==="discharge_mode"?"#1B6EF3":"currentColor",size:"28"}),onClick:()=>L()})]}),e.jsx(X,{children:m.map((t,s)=>e.jsxs("div",{className:"advance-start-row",children:[e.jsx("div",{className:"close-row",children:e.jsx(f,{type:"link",onClick:()=>$(s),icon:e.jsx(D,{icon:"Close",size:"20",color:"#C3C3C3"})})}),e.jsxs("div",{className:"label-value-split ",children:[e.jsxs("div",{className:"mock-column",children:[e.jsx("div",{className:"required label",children:"Limit(W)"}),e.jsx(M,{min:1,max:1e5,value:t.limit,placeholder:j==="current"?"Current limit":"Power limit",onChange:a=>G(s,a)})]}),e.jsxs("div",{className:"mock-column",children:[e.jsx("div",{className:"required label",children:"Duration(Minutes)"}),e.jsx(M,{min:1,max:1e5,placeholder:"Input",value:t.startAfter,onChange:a=>K(s,a)})]})]},s)]},`setting-${t.time}`))})]})]})})})}export{de as default};
