import{j as s,S as u}from"./index-COmHBfD9.js";import{K as te,w as h,i,J as ae,P as S,F as ne,z as oe,s as re,O as c}from"./vendor-antd-BiNc4BQP.js";import{r as n}from"./vendor-react-DcqtUZ_G.js";import{c as C}from"./commonService-Cu_m0QKL.js";import{c as ie}from"./cpMonitorService-Cz9cMpL7.js";import{s as v}from"./scheduleService-CjXfYmXw.js";import{e as le}from"./options-CwsqYUdd.js";import ce from"./addChargingSchedule-BAZ_VzGA.js";import de from"./detail-44dIWkqu.js";import me from"./editChargingSchedule-fyA6kjYs.js";import"./vendor-ui-BASYQBt4.js";import"./vendor-utils-DcB4TerO.js";function we(){const[w,p]=n.useState(!1),[D,f]=n.useState(!1),[d,M]=n.useState([]),[b,x]=n.useState(!1),[g,j]=n.useState(null),[o,r]=n.useState({}),[k,l]=n.useState(0),[N,Y]=n.useState([]),[m,I]=n.useState([]),[P,E]=n.useState([]),[H,y]=n.useState(!1),[T,A]=n.useState(0),R=[{title:"Charge Point",dataIndex:"id_tag",key:"id_tag",render:(e,t)=>s.jsx(i,{type:"link",onClick:()=>O(t),children:e})},{title:"Scheduled Time",dataIndex:"scheduled_time",key:"scheduled_time"},{title:"Energy Mode",dataIndex:"session_mode",key:"session_mode",render:e=>s.jsx("span",{className:e==="Discharge"?"discharge_mode":"charge_mode",children:e})},{title:"Duration",dataIndex:"duration",key:"duration"},{title:"Repeat Kind",dataIndex:"repeat_kind",key:"repeat_kind"},{title:"Operation",width:"140px",key:"operation",render:(e,t)=>s.jsx("div",{className:"operations",children:s.jsx(S,{title:"Confirm delete?",placement:"bottom",okText:"Confirm",cancelText:"Cancel",onConfirm:()=>{_(t.id)},children:s.jsx(i,{type:"link",danger:!0,icon:s.jsx(u,{icon:"Delete",size:"20"}),children:"Delete"})})})}],K=()=>{p(!0)},$=e=>{j(e),f(!0)},O=e=>{j(e),x(!0)},V=e=>{M(e)},z=()=>{const e={...o};delete e.page,r(e),l(Date.now())},L=e=>{r({...o,page:e}),l(Date.now())},U=()=>{r({}),l(Date.now())},q=async()=>{const{detail:e}=await C.getUsers({num:100});Y(e.results.map(a=>({name:`${a.first_name} ${a.last_name}`,phone:a.phone,email:a.email,user_id:a.user_id})));const t=await ie.queryAll({num:100});I(t.detail.results.map(a=>({id:a.id,id_tag:a.id_tag,v2g_support:a.v2g_support,connector_no:a.brand_model.connector_no})))},B=e=>e.map(t=>{const a=(new Date(t.profile_end_datetime).getTime()-new Date(t.profile_start_datetime).getTime())/1e3,Q=Math.floor(a/3600),G=Math.floor(a%3600/60),W=Math.floor(a%60),{id:X,last_name:Z,first_name:ee}=t,se=c().startOf("day").add(Q,"hour").add(G,"minute").add(W,"second").format("HH:mm:ss");return{...t,key:X,user:`${Z} ${ee}`,repeat_kind:t.ocpp_recurrency_kind||"",session_mode:t.mode==="1"?"Charge":"Discharge",duration:se,start_time:c(t.profile_start_datetime).format("YYYY-MM-DD HH:mm:ss"),end_time:c(t.profile_end_datetime).format("YYYY-MM-DD HH:mm:ss"),scheduled_time:`${c(t.profile_start_datetime).format("YYYY-MM-DD HH:mm:ss")} - ${c(t.profile_end_datetime).format("YYYY-MM-DD HH:mm:ss")}`}}),F=async()=>{y(!0);const e=await v.queryAll(o),{results:t,count:a}=e.detail;E(B(t||[])),A(a),y(!1)},J=()=>d.map(e=>e.split(C.rowKeySplit)[0]),_=async e=>{try{const t=await v.del({charge_profile_ids:e?[e]:J()});t?.code===200&&(re.success(t.message),l(Date.now()))}catch{}};return n.useEffect(()=>{F()},[k]),n.useEffect(()=>{q(),l(Date.now())},[]),s.jsxs("div",{className:"main-content",children:[s.jsxs("div",{className:"search-area flex items-center justify-start",children:[s.jsxs("div",{className:"search-item",children:[s.jsx("div",{className:"label mb-2",children:"Charge Point"}),s.jsx(te,{className:"w-full",placeholder:"Enter",onChange:e=>{r({...o,id_tag:e.target.value})}})]}),s.jsxs("div",{className:"search-item",children:[s.jsx("div",{className:"label",children:"User"}),s.jsx(h,{className:"w-full",allowClear:!0,value:o.user_id,style:{width:"150px"},onChange:e=>{r({...o,user_id:e})},placeholder:"Select",children:N.map(e=>s.jsx(h.Option,{value:e.user_id,children:e.name},e.user_id))})]}),s.jsxs("div",{className:"search-item",children:[s.jsx("div",{className:"label",children:"Energy Mode"}),s.jsx(h,{placeholder:"Select",allowClear:!0,style:{width:"210px"},onChange:e=>{r({...o,session_mode:e})},children:le.map(e=>s.jsx(h.Option,{value:e.value,children:e.label},e.value))})]}),s.jsx("div",{className:"search-btn",children:s.jsx(i,{icon:s.jsx(u,{icon:"Search",size:"20"}),type:"primary",loading:H,onClick:z})}),s.jsx("div",{className:"search-btn clear",children:s.jsx(i,{icon:s.jsx(u,{icon:"Close",size:"24",color:"#999"}),type:"primary",onClick:U})})]}),s.jsx("div",{className:"flex items-center justify-between",children:s.jsxs("div",{className:"operation-area flex items-center justify-start",children:[s.jsx(i,{type:"primary",icon:s.jsx(ae,{}),onClick:K,children:"Add Schedule"}),s.jsx(S,{placement:"bottom",okText:"Confirm",cancelText:"Cancel",title:"Confirm delete?",onConfirm:()=>{_()},children:s.jsx(i,{disabled:d.length===0,className:"ml-3",icon:s.jsx(u,{color:d.length===0?"#999":"currentColor",icon:"Stop",size:"20"}),children:"Bulk Delete"})})]})}),s.jsx(ne,{columns:R,dataSource:P,pagination:!1,rowKey:"key",rowSelection:{selectedRowKeys:d,onChange:V}}),s.jsx("div",{className:"mr-4 mt-4 flex justify-end",children:s.jsx(oe,{total:T,showQuickJumper:!0,onChange:L})}),m.length>0&&s.jsx(ce,{visible:w,onCancel:()=>p(!1),onConfirm:()=>p(!1),chargePoints:m}),m.length>0&&g&&s.jsx(me,{visible:D,chargePoints:m,onCancel:()=>f(!1),onConfirm:()=>f(!1),record:g}),s.jsx(de,{visible:b,onCancel:()=>x(!1),record:g,onDelete:e=>{_(e),x(!1)},onEdit:$})]})}export{we as default};
