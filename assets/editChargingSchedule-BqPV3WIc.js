import{j as e,S as j}from"./index-cql_hjB4.js";import{O as P,H as i,E as X,i as g,w as o,k as E,Q as C,$ as T,o as Z,x as N,j as ee,s as b}from"./vendor-antd-BiNc4BQP.js";import{r as d}from"./vendor-react-DcqtUZ_G.js";import{s as te}from"./scheduleService-BDYnA8sc.js";import{d as O,b as ae,r as re}from"./options-CwsqYUdd.js";import"./vendor-ui-BASYQBt4.js";import"./vendor-utils-DcB4TerO.js";function me({visible:f,onCancel:A,record:r,chargePoints:y,onConfirm:Y}){const p=y?.find(t=>t.id===r?.charge_point_id),q=p?.connector_no===2?O:[O[0]],H=P(r.profile_start_datetime),L=P(r.profile_end_datetime),l=r?.mode==="1"?"charge_mode":"discharge_mode",I=r.soc[r.mode==="1"?"max":"min"]*100,k=r?.ocpp_charging_schedule_period?.map(t=>({limit:t.limit,startAfter:t.startPeriod/60,time:Date.now()})),[v]=i.useForm(),[R,D]=d.useState(!1),[_,z]=d.useState(k.length>0),[m,u]=d.useState([{limit:"",startAfter:"",time:Date.now()}]),[w,B]=d.useState(r.ocpp_charging_rate_unit==="A"?"current":"power"),[S,F]=d.useState(p?.v2g_support||!1),[x,V]=d.useState(I);d.useEffect(()=>{f&&(v.setFieldsValue({charge_point_id:p?.id_tag,connector_id:r?.connector_id,repeat_kind:r.ocpp_recurrency_kind||"No",start_time:H,end_time:L,mode:l,soc:I}),u(k))},[f,r]);const W=()=>{F(!0),u([...m,{limit:"",startAfter:"",time:Date.now()}])},$=t=>{z(t)},G=t=>{B(t),u([{limit:"",startAfter:"",time:Date.now()}])},K=t=>{const s=m.filter((a,n)=>n!==t);u([...s])},Q=(t,s)=>{const a=[...m],n=a.map((c,h)=>h===t?{...a[t]||{limit:"",startAfter:"",time:Date.now()},limit:s}:c);u(n)},J=(t,s)=>{const a=[...m],n=a.map((c,h)=>h===t?{...a[t]||{limit:"",startAfter:"",time:Date.now()},startAfter:s}:c);u(n)},U=async()=>{let t=!0;const s=_?m.map(a=>((a.limit===""||a.startAfter==="")&&(t=!1),{limit:a.limit,startPeriod:a.startAfter*60})):[];if(_&&(!t||s.length===0)){b.error("Please Input Limit and Start After");return}if(S&&!x){b.error("Please Enter Soc");return}v.validateFields().then(async a=>{let n={max:.92};p.v2g_support==="V2G"&&(n=l==="charge_mode"?{max:(x||0)/100}:{min:(x||0)/100});let c={charge_point_id:p.id,connector_id:a.connector_id,mode:l==="charge_mode"?"default":"v2g",soc:n,ocpp_charging_schedule_period:s};c={...c,smart_charge:!0,profile_start_datetime:new Date(a.start_time).toISOString(),profile_end_datetime:new Date(a.end_time).toISOString(),ocpp_charging_profile_id:r?.ocpp_charging_profile_id,ocpp_stack_level:2,ocpp_charging_profile_purpose:"TxProfile",ocpp_charging_profile_kind:"Relative",ocpp_charging_rate_unit:w==="current"?"A":"B",ocpp_recurrency_kind:a.repeat_kind};const h=[c];D(!0);const M=await te.update(r.id,{...h});D(!1),M?.code===200&&(b.success(M.message),Y())})};return e.jsx(X,{title:"Edit Schedule",open:f,onCancel:A,zIndex:1002,footer:[e.jsxs("div",{className:"footer-normal-btns",children:[e.jsx(g,{onClick:A,children:"Cancel"},"cancel"),e.jsx(g,{type:"primary",loading:R,onClick:U,children:"Add"},"confirm")]},"add-schedule-footer")],children:e.jsx("div",{className:`modal-form ${l}_form`,children:e.jsxs(i,{form:v,layout:"vertical",children:[e.jsx(i.Item,{name:"charge_point_id",label:"Charge Point",rules:[{required:!0}],children:e.jsx(o,{className:"w-full",allowClear:!0,disabled:!0,placeholder:"Select",children:y.map(t=>e.jsx(o.Option,{value:t.id_tag,children:t.id_tag},t.id_tag))})}),e.jsxs("div",{className:"two-column",children:[e.jsx(i.Item,{name:"connector_id",label:"Connector",rules:[{required:!0}],children:e.jsx(o,{className:"w-full",allowClear:!0,placeholder:"Select",children:q.map(t=>e.jsx(o.Option,{value:t.value,children:t.label},t.value))})}),e.jsx(i.Item,{label:""})]}),e.jsxs("div",{className:"two-column",children:[e.jsx(i.Item,{name:"mode",label:"Energy Mode",rules:[{required:!0}],children:S?e.jsx(o,{placeholder:"Select",value:l,style:{width:"100%"},children:ae.map(t=>e.jsx(o.Option,{value:t.value,children:e.jsx("span",{className:t.value,children:t.label})},t.value))}):e.jsx("div",{className:"form-status charge_mode",children:"Charge Mode"})}),S?e.jsx(i.Item,{label:"",children:e.jsxs("div",{className:"soc-form-wrapper",children:[e.jsx("label",{children:l==="charge_mode"?e.jsxs("div",{className:"icon-label",children:[e.jsx("span",{children:"Max Soc(%)"}),e.jsx(E,{title:"Maximum Charge Limit Is 95%",placement:"top",children:e.jsx("span",{className:"svg-wrapper",children:e.jsx(j,{className:"ml-1",icon:"Help",size:"20"})})})]}):e.jsxs("div",{className:"icon-label",children:[e.jsx("span",{children:"Min Soc(%)"}),e.jsx(E,{title:"Minimum Discharge Limit Is 20%",placement:"top",children:e.jsx("span",{children:e.jsx(j,{className:"ml-1",icon:"Help",size:"20"})})})]})}),e.jsx(C,{min:l==="charge_mode"?1:20,max:l==="charge_mode"?95:1e4,placeholder:"Enter",value:x,onChange:t=>V(t)})]})}):e.jsx(i.Item,{label:""})]}),e.jsxs("div",{className:"two-column",children:[e.jsx(i.Item,{name:"start_time",label:"Start Time",rules:[{required:!0}],children:e.jsx(T,{showTime:!0,format:"YYYY-MM-DD HH:mm"})}),e.jsx(i.Item,{name:"end_time",label:"End Time",rules:[{required:!0}],children:e.jsx(T,{showTime:!0,format:"YYYY-MM-DD HH:mm"})})]}),e.jsxs("div",{className:"two-column",children:[e.jsx(i.Item,{name:"repeat_kind",label:"Repeat Kind",children:e.jsx(o,{allowClear:!0,children:re.map(t=>e.jsx(o.Option,{value:t.value,children:t.label},t.value))})}),e.jsx(i.Item,{label:""})]}),e.jsxs("div",{className:"between-wrapper mt-2",children:[e.jsx("span",{}),e.jsxs("div",{className:"switch",children:["With Profile",e.jsx(Z,{checked:_,onChange:$})]})]}),_&&e.jsxs("div",{className:"mt-4",children:[e.jsxs("div",{className:"between-wrapper",children:[e.jsxs(N.Group,{optionType:"button",value:w,onChange:t=>G(t.target.value),className:"my-4",children:[e.jsx(N.Button,{value:"current",children:"Current"}),e.jsx(N.Button,{value:"power",children:"Power"})]}),e.jsx(g,{type:"link",icon:e.jsx(j,{icon:l==="discharge_mode"?"Add2":"Add",color:l==="discharge_mode"?"#1B6EF3":"currentColor",size:"28"}),onClick:()=>W()})]}),e.jsx(ee,{children:m.map((t,s)=>e.jsxs("div",{className:"advance-start-row",children:[e.jsx("div",{className:"close-row",children:e.jsx(g,{type:"link",onClick:()=>K(s),icon:e.jsx(j,{icon:"Close",size:"20",color:"#C3C3C3"})})}),e.jsxs("div",{className:"label-value-split ",children:[e.jsxs("div",{className:"mock-column",children:[e.jsx("div",{className:"required label",children:"Limit(W)"}),e.jsx(C,{min:1,max:1e5,value:t.limit,placeholder:w==="current"?"Current limit":"Power limit",onChange:a=>Q(s,a)})]}),e.jsxs("div",{className:"mock-column",children:[e.jsx("div",{className:"required label",children:"Duration(Minutes)"}),e.jsx(C,{min:1,max:1e5,placeholder:"Input",value:t.startAfter,onChange:a=>J(s,a)})]})]},s)]},`setting-${t.time}`))})]})]})})})}export{me as default};
